<div class="recommendations-page">
  <header class="page-hero">
    <div class="hero-copy">
      <span class="eyebrow">Modulo ML Agro</span>
      <h1>Recomendaciones inteligentes de siembra</h1>
      <p>
        Ajusta los parametros clave del lote y obten ventanas optimas de siembra respaldadas por
        modelos predictivos y factores agronomicos priorizados.
      </p>
    </div>

    <div class="hero-metrics">
      <div class="metric-tile">
        <span class="metric-label">Cultivos soportados</span>
        <span class="metric-value">{{ cultivos.length }}</span>
      </div>
    </div>
  </header>

  <div class="content-grid" [class.has-result]="!!result">
    <section class="panel panel-form">
      <header class="panel-header">
        <div>
          <h2>Configura la consulta</h2>
          <p>Define la campana, lote y cultivo antes de solicitar la recomendacion.</p>
        </div>
      </header>

      <form [formGroup]="recommendationForm" (ngSubmit)="onSubmit()" class="form-grid">
        <div class="field-group">
          <label for="loteId">Lote</label>
          <select id="loteId" formControlName="loteId">
            <option *ngFor="let lote of lotes" [value]="lote.value">{{ lote.label }}</option>
          </select>
        </div>

        <div class="field-group">
          <label for="cultivo">Cultivo</label>
          <div class="chip-group">
            <button
              type="button"
              class="chip"
              *ngFor="let cultivo of cultivos"
              [class.chip-active]="recommendationForm.value.cultivo === cultivo"
              (click)="onCultivoSelect(cultivo)"
            >
              {{ cultivo | titlecase }}
            </button>
          </div>
        </div>

        <div class="field-group">
          <label for="campana">Campaña</label>
          <select id="campana" formControlName="campana">
            <option value="2025/2026">2025/2026</option>
            <option value="2026/2027">2026/2027</option>
            <option value="2027/2028">2027/2028</option>
          </select>
        </div>

        

        <div class="form-actions">
          <button type="submit" class="btn btn-primary" [disabled]="isLoading || recommendationForm.invalid">
            <span *ngIf="!isLoading">Generar recomendacion</span>
            <span *ngIf="isLoading">
              <span class="loading"></span>
              Procesando...
            </span>
          </button>
        </div>
      </form>
    </section>

    <section class="panel panel-result" *ngIf="result || error || isLoading">
      <div class="loader" *ngIf="isLoading">
        <div class="loading"></div>
        <p>Generando recomendacion...</p>
      </div>

      <div class="alert alert-error" *ngIf="error && !isLoading">
        <strong>Error:</strong> {{ error }}
      </div>

      <ng-container *ngIf="result && !isLoading">
        <header class="result-header">
          <div>
            <span class="pill">{{ result.tipo_recomendacion | titlecase }}</span>
            <h2>Plan recomendado para {{ getLoteLabel(result.lote_id) }}</h2>
            <p class="result-subtitle">
              Cultivo: {{ result.cultivo | titlecase }} | Campaña: {{ getDatosEntradaCampana() }}
            </p>
          </div>
        </header>

        <div class="result-grid">
          <article class="result-card">
            <h3>Recomendación principal</h3>
            <div class="main-window">
              <span class="date">{{ formatDate(result.recomendacion_principal.fecha_optima) }}</span>
              <span class="range-label">Ventana de siembra óptima:</span>
              <span class="range">{{ formatVentana(result.recomendacion_principal.ventana) }}</span>
              <span class="confidence-inline">Confianza: {{ result.recomendacion_principal.confianza * 100 | number: '1.0-0' }}%</span>
              <div *ngIf="result.recomendacion_principal.riesgos?.length">
                <span class="range-label">Riesgos</span>
                <ul class="tag-list">
                  <li *ngFor="let riesgo of result.recomendacion_principal.riesgos">{{ riesgo }}</li>
                </ul>
              </div>
            </div>
          </article>

          <article class="result-card" *ngIf="result.alternativas?.length">
            <h3>Alternativa</h3>
            <div class="alternative-grid">
              <div class="alternative-card" *ngFor="let alt of result.alternativas; trackBy: trackByAlternative">
                <!-- Descripción del escenario climático -->
                <div class="scenario-badge" *ngIf="alt.escenario_climatico">
                  <span class="scenario-name">{{ alt.escenario_climatico.nombre }}</span>
                  <p class="scenario-description">{{ alt.escenario_climatico.descripcion }}</p>
                </div>
                
                <div class="main-window">
                  <span class="date">{{ formatDate(alt.fecha) }}</span>
                  <span class="range-label">Ventana de siembra óptima:</span>
                  <span class="range">{{ formatVentana(alt.ventana) }}</span>
                  <span class="confidence-inline">Confianza: {{ alt.confianza * 100 | number: '1.0-0' }}%</span>
                </div>
                
                <div class="alt-pros-cons">
                  <div *ngIf="alt.pros?.length">
                    <span class="label">Pros</span>
                    <ul class="chip-list">
                      <li *ngFor="let it of alt.pros">{{ it }}</li>
                    </ul>
                  </div>
                  <div *ngIf="alt.contras?.length">
                    <span class="label">Contras</span>
                    <ul class="chip-list chip-list-warn">
                      <li *ngFor="let it of alt.contras">{{ it }}</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </article>

          <article class="result-card" *ngIf="result.factores_considerados?.length">
            <h3>Factores considerados</h3>
            <ul class="factor-grid">
              <li *ngFor="let factor of result.factores_considerados">{{ factor }}</li>
            </ul>
          </article>

          <article class="result-card" *ngIf="result.costos_estimados && (result.costos_estimados | keyvalue).length">
            <h3>Costos estimados</h3>
            <dl class="costs-grid">
              <div *ngFor="let item of result.costos_estimados | keyvalue">
                <dt>{{ item.key | titlecase }}</dt>
                <dd>{{ item.value | currency: 'USD':'symbol':'1.0-0' }}</dd>
              </div>
            </dl>
          </article>

          <article class="result-card" *ngIf="result.metadata">
            <h3>Metadatos</h3>
            <pre>{{ result.metadata | json }}</pre>
          </article>
        </div>

        <footer class="result-footer">
          <span>Generado el {{ formatDateTime(result.fecha_generacion) }}</span>
        </footer>
      </ng-container>
    </section>
  </div>
</div>