<div class="dashboard">
  <header class="dashboard-header">
    <div class="header-text">
      <h1>Historial de recomendaciones</h1>
      <p>Consulta las predicciones generadas recientemente para tus lotes.</p>
    </div>
    <span class="total-chip" *ngIf="!isLoading && !error">
      <ng-container *ngIf="isLocalSearchActive && filteredCount !== totalHistory; else totalSummary">
        Mostrando {{ filteredCount }} de {{ totalHistory }} recomendaciones
      </ng-container>
      <ng-template #totalSummary>
        {{ totalSummaryText }}
      </ng-template>
    </span>
  </header>

  <section class="filters-panel" [formGroup]="serverFiltersForm">
    <div class="filter-grid">
      <div class="filter-control">
        <label for="filter-lote">Lote</label>
        <select id="filter-lote" formControlName="lote_id">
          <option value="">Todos</option>
          <option *ngFor="let lote of availableLotes" [value]="lote.value">{{ lote.label }}</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="filter-cultivo">Cultivo</label>
        <select id="filter-cultivo" formControlName="cultivo">
          <option value="">Todos</option>
          <option *ngFor="let cultivo of availableCultivos" [value]="cultivo">{{ cultivo | titlecase }}</option>
        </select>
      </div>
      <div class="filter-control">
        <label for="filter-campana">Campa√±a</label>
        <select id="filter-campana" formControlName="campana">
          <option value="">Todas</option>
          <option *ngFor="let campana of availableCampanas" [value]="campana">{{ campana }}</option>
        </select>
      </div>
    </div>
    <div class="search-control">
      <label for="filter-search">B√∫squeda r√°pida</label>
      <input
        id="filter-search"
        type="search"
        placeholder="Filtra por lote, cultivo, campa√±a o fecha"
        [formControl]="localSearchControl" />
    </div>
  </section>

  <section class="panel loading-panel" *ngIf="isLoading">
    <div class="loading"></div>
    <p>Cargando historial de predicciones...</p>
  </section>

  <section class="panel alert-panel" *ngIf="error && !isLoading">
    <div class="alert alert-error">
      <div>
        <strong>Error:</strong> {{ error }}
        <p>No pudimos recuperar el historial de predicciones. Intenta nuevamente.</p>
      </div>
      <button class="btn btn-secondary" type="button" (click)="loadDashboardData()">Reintentar</button>
    </div>
  </section>

  <section class="history-panel" *ngIf="!isLoading && !error">
    <header class="history-header">
      <div>
        <h2>√öltimas predicciones</h2>
        <p>Mostrando {{ historyItems.length }} coincidencias filtradas de {{ totalHistory }} registros disponibles.</p>
      </div>
      <button class="btn btn-secondary" type="button" (click)="loadDashboardData()">Actualizar</button>
    </header>

    <ng-container *ngIf="historyItems.length; else noResults">
      <div class="table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Lote</th>
              <th>Cultivo</th>
              <th>Campa√±a</th>
              <th>Confianza</th>
              <th>Fecha √≥ptima</th>
              <th>Ventana recomendada</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historyItems">
              <td>{{ item.fecha_creacion ? (item.fecha_creacion | date:'short') : '‚Äî' }}</td>
              <td>{{ getLoteLabel(item.lote_id) }}</td>
              <td class="capitalize">{{ item.cultivo || '‚Äî' }}</td>
              <td>{{ item.campana || '‚Äî' }}</td>
              <td>
                <ng-container *ngIf="resolveConfidence(item) as confidence; else dash">
                  {{ confidence | percent:'1.0-0' }}
                </ng-container>
              </td>
              <td>{{ formatRecommendationDate(item.recomendacion_principal.fecha_optima) }}</td>
              <td class="window-cell">
                <ng-container *ngIf="item.recomendacion_principal.ventana.length === 2; else dash">
                  <span>{{ formatRecommendationDate(item.recomendacion_principal.ventana[0]) }}</span>
                  <span class="range-separator">‚Üí</span>
                  <span>{{ formatRecommendationDate(item.recomendacion_principal.ventana[1]) }}</span>
                </ng-container>
              </td>
              <td class="actions-cell">
                <button 
                  type="button" 
                  class="btn btn-icon" 
                  (click)="downloadRecommendationPdf(item)"
                  [disabled]="isDownloadingPdf(item.id)"
                  title="Descargar PDF de esta recomendaci√≥n"
                >
                  <span *ngIf="!isDownloadingPdf(item.id)">üì•</span>
                  <span *ngIf="isDownloadingPdf(item.id)" class="loading"></span>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>

    <ng-template #noResults>
      <ng-container *ngIf="!hasServerResults; else noMatches">
        <div class="empty-state">
          <h3>No se registran predicciones a√∫n</h3>
          <p>Genera una recomendaci√≥n desde la secci√≥n de recomendaciones para comenzar a ver el historial aqu√≠.</p>
        </div>
      </ng-container>
    </ng-template>

    <ng-template #noMatches>
      <div class="empty-state">
        <h3>Sin coincidencias</h3>
        <p>Ajusta los filtros o limpia la b√∫squeda para ver resultados.</p>
      </div>
    </ng-template>

    <ng-template #dash>‚Äî</ng-template>
  </section>
</div>
